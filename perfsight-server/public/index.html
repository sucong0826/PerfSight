<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PerfSight Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js for simple charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;

    // ========================
    // API Client
    // ========================
    const api = {
      async getRuns(filters = {}) {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([k, v]) => { if (v) params.set(k, v); });
        const res = await fetch(`/api/v1/runs?${params}`);
        return res.json();
      },
      async getRun(id) {
        const res = await fetch(`/api/v1/runs/${id}`);
        return res.json();
      },
      async getFilters() {
        const res = await fetch('/api/v1/filters');
        return res.json();
      },
      async deleteRun(id) {
        const res = await fetch(`/api/v1/runs/${id}`, { method: 'DELETE' });
        return res.json();
      },
    };

    // ========================
    // Utility Functions
    // ========================
    const formatDate = (d) => new Date(d).toLocaleString();
    const formatDuration = (s) => s ? `${Math.floor(s / 60)}m ${s % 60}s` : '—';
    const formatCpu = (v) => v != null ? `${v.toFixed(1)}%` : '—';
    const formatMem = (v) => v != null ? `${v.toFixed(1)} MB` : '—';

    const COLORS = {
      BASELINE: '#6366f1', // indigo
      PALETTE: ['#f59e0b', '#10b981', '#06b6d4', '#8b5cf6', '#ef4444', '#ec4899', '#84cc16', '#14b8a6'],
    };

    const percentile = (arr, q) => {
      if (!arr.length) return null;
      const sorted = [...arr].sort((a, b) => a - b);
      const idx = Math.round((sorted.length - 1) * q);
      return sorted[Math.min(Math.max(idx, 0), sorted.length - 1)];
    };
    const avg = (arr) => arr.length ? arr.reduce((s, v) => s + v, 0) / arr.length : null;
    const stddev = (arr, mean) => {
      if (!arr.length || mean == null) return null;
      const v = arr.reduce((acc, x) => acc + (x - mean) * (x - mean), 0) / arr.length;
      return Math.sqrt(v);
    };
    const linregSlope = (ys) => {
      const n = ys.length;
      if (n <= 1) return 0;
      const sumX = ((n - 1) * n) / 2;
      let sumY = 0, sumXY = 0, sumXX = 0;
      for (let i = 0; i < n; i++) {
        sumY += ys[i];
        sumXY += i * ys[i];
        sumXX += i * i;
      }
      const denom = n * sumXX - sumX * sumX;
      return denom === 0 ? 0 : (n * sumXY - sumX * sumY) / denom;
    };

    // ========================
    // Chart Component using Chart.js
    // ========================
    function LineChartComponent({ data, dataKeys, title, yLabel, formatValue }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!canvasRef.current || !data.length) return;

        if (chartRef.current) {
          chartRef.current.destroy();
        }

        const ctx = canvasRef.current.getContext('2d');
        const datasets = dataKeys.map((key, idx) => ({
          label: key.label,
          data: data.map(d => d[key.key]),
          borderColor: key.color || COLORS.PALETTE[idx % COLORS.PALETTE.length],
          backgroundColor: (key.color || COLORS.PALETTE[idx % COLORS.PALETTE.length]) + '20',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.3,
          fill: false,
        }));

        chartRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => `${Math.round(d.elapsed || d.time_s || 0)}s`),
            datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${formatValue ? formatValue(ctx.raw) : ctx.raw}`,
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: 'Time' },
                ticks: { maxTicksLimit: 10 },
              },
              y: {
                title: { display: true, text: yLabel },
                beginAtZero: true,
              },
            },
          },
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [data, dataKeys]);

      return (
        <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
          <h3 className="font-medium text-slate-800 mb-4">{title}</h3>
          <div className="h-[300px]">
            <canvas ref={canvasRef}></canvas>
          </div>
        </div>
      );
    }

    // ========================
    // RunsList Component
    // ========================
    function RunsList({ onSelect, onCompare }) {
      const [runs, setRuns] = useState([]);
      const [filters, setFilters] = useState({});
      const [filterOptions, setFilterOptions] = useState({});
      const [loading, setLoading] = useState(true);
      const [importing, setImporting] = useState(false);
      const [selectedIds, setSelectedIds] = useState(new Set());
      const fileInputRef = useRef(null);

      const loadRuns = () => {
        setLoading(true);
        api.getRuns(filters)
          .then(data => setRuns(data.runs || []))
          .finally(() => setLoading(false));
      };

      useEffect(() => {
        api.getFilters().then(setFilterOptions).catch(console.error);
      }, []);

      useEffect(() => {
        loadRuns();
      }, [filters]);

      const handleDelete = async (e, id) => {
        e.stopPropagation();
        if (!confirm('Delete this run?')) return;
        await api.deleteRun(id);
        setRuns(runs.filter(r => r.id !== id));
        setSelectedIds(prev => {
          const next = new Set(prev);
          next.delete(id);
          return next;
        });
      };

      const handleImport = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        try {
          setImporting(true);
          const text = await file.text();
          const data = JSON.parse(text);
          
          // Check if it's a comparison bundle
          if (data.bundle_type === 'comparison' && Array.isArray(data.reports)) {
            // Import as bundle
            const res = await fetch('/api/v1/bundles', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: text,
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || `Bundle import failed: ${res.status}`);
            }

            const result = await res.json();
            const importedCount = result.imported?.length || 0;
            
            alert(`✅ Comparison Bundle imported!\n${importedCount} reports imported.\n\nOpening Compare view...`);
            
            loadRuns();
            api.getFilters().then(setFilterOptions).catch(console.error);
            
            // Navigate to compare view with the imported run IDs
            if (result.comparison?.runIds?.length >= 2) {
              // Pass the comparison context to onCompare
              onCompare(result.comparison.runIds, result.comparison);
            }
          } else if (data.schema_version === 1 && data.report) {
            // Single dataset import
            const res = await fetch('/api/v1/datasets', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: text,
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.error || `Upload failed: ${res.status}`);
            }

            const result = await res.json();
            alert(`✅ Import successful!\nRun ID: ${result.run?.id}\nTitle: ${result.run?.title}`);
            
            loadRuns();
            api.getFilters().then(setFilterOptions).catch(console.error);
          } else {
            throw new Error('Invalid format. Expected a dataset (schema_version: 1 + report) or comparison bundle (bundle_type: "comparison" + reports array).');
          }
        } catch (err) {
          console.error('Import failed:', err);
          alert(`❌ Import failed: ${err.message}`);
        } finally {
          setImporting(false);
          if (fileInputRef.current) fileInputRef.current.value = '';
        }
      };

      const toggleSelect = (e, id) => {
        e.stopPropagation();
        setSelectedIds(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      const handleCompare = () => {
        if (selectedIds.size >= 2) {
          onCompare(Array.from(selectedIds));
        }
      };

      return (
        <div className="p-6">
          <div className="flex items-center justify-between mb-6">
            <h1 className="text-2xl font-bold text-slate-800">Test Reports</h1>
            <div className="flex items-center gap-4">
              {selectedIds.size >= 2 && (
                <button
                  onClick={handleCompare}
                  className="flex items-center gap-2 bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                  Compare ({selectedIds.size})
                </button>
              )}
              <div className="text-sm text-slate-500">{runs.length} reports</div>
              <input
                type="file"
                accept=".json"
                ref={fileInputRef}
                onChange={handleImport}
                className="hidden"
                id="import-file-input"
              />
              <button
                onClick={() => fileInputRef.current?.click()}
                disabled={importing}
                className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-60 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                {importing ? (
                  <>
                    <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                    </svg>
                    Importing...
                  </>
                ) : (
                  <>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Import Dataset
                  </>
                )}
              </button>
            </div>
          </div>

          {/* Filters */}
          <div className="flex flex-wrap gap-3 mb-6 p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
            <select 
              className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm"
              value={filters.release || ''}
              onChange={e => setFilters({...filters, release: e.target.value})}
            >
              <option value="">All Releases</option>
              {(filterOptions.releases || []).map(r => 
                <option key={r} value={r}>{r}</option>
              )}
            </select>
            <select 
              className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm"
              value={filters.scenario || ''}
              onChange={e => setFilters({...filters, scenario: e.target.value})}
            >
              <option value="">All Scenarios</option>
              {(filterOptions.scenarios || []).map(s => 
                <option key={s} value={s}>{s}</option>
              )}
            </select>
            <select 
              className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm"
              value={filters.platform || ''}
              onChange={e => setFilters({...filters, platform: e.target.value})}
            >
              <option value="">All Platforms</option>
              {(filterOptions.platforms || []).map(p => 
                <option key={p} value={p}>{p}</option>
              )}
            </select>
            <input 
              type="text"
              placeholder="Search by build ID..."
              className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm w-48"
              value={filters.buildId || ''}
              onChange={e => setFilters({...filters, buildId: e.target.value})}
            />
            {Object.values(filters).some(Boolean) && (
              <button 
                onClick={() => setFilters({})}
                className="px-3 py-2 text-sm text-slate-500 hover:text-slate-700"
              >
                Clear
              </button>
            )}
          </div>

          {/* Runs List */}
          {loading ? (
            <div className="text-center py-12 text-slate-500">Loading...</div>
          ) : runs.length === 0 ? (
            <div className="text-center py-12 text-slate-500">
              No reports found. Upload a dataset from PerfSight Desktop.
            </div>
          ) : (
            <div className="space-y-3">
              {runs.map(run => {
                const isSelected = selectedIds.has(run.id);
                return (
                  <div 
                    key={run.id}
                    onClick={() => onSelect(run.id)}
                    className={`bg-white border rounded-xl p-4 cursor-pointer transition-colors shadow-sm ${
                      isSelected 
                        ? 'border-indigo-500 bg-indigo-50/30' 
                        : 'border-slate-200 hover:border-indigo-400'
                    }`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex items-start gap-3 min-w-0 flex-1">
                        <button
                          onClick={(e) => toggleSelect(e, run.id)}
                          className="mt-1 shrink-0"
                        >
                          {isSelected ? (
                            <svg className="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                            </svg>
                          ) : (
                            <svg className="w-5 h-5 text-slate-300 hover:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="10" strokeWidth="2" />
                            </svg>
                          )}
                        </button>
                        <div className="min-w-0 flex-1">
                          <div className="font-medium text-slate-800 truncate">{run.title}</div>
                          <div className="text-sm text-slate-500 mt-1">
                            {formatDate(run.reportDate)}
                            {run.durationSeconds && <span className="ml-3">⏱ {formatDuration(run.durationSeconds)}</span>}
                          </div>
                          <div className="flex flex-wrap gap-2 mt-2">
                            {run.release && (
                              <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-medium">
                                {run.release}
                              </span>
                            )}
                            {run.scenario && (
                              <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded text-xs">
                                {run.scenario}
                              </span>
                            )}
                            {run.platform && (
                              <span className="px-2 py-0.5 bg-slate-100 text-slate-600 rounded text-xs">
                                {run.platform}
                              </span>
                            )}
                            {run.mode && (
                              <span className="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs">
                                {run.mode}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                      <div className="text-right ml-4 shrink-0">
                        <div className="text-sm">
                          <span className="text-slate-500">CPU:</span>{' '}
                          <span className="font-medium">{formatCpu(run.avgCpu)}</span>
                          {run.p95Cpu != null && (
                            <span className="text-slate-400 ml-1">(P95: {formatCpu(run.p95Cpu)})</span>
                          )}
                        </div>
                        <div className="text-sm mt-1">
                          <span className="text-slate-500">Mem:</span>{' '}
                          <span className="font-medium">{formatMem(run.avgMemMb)}</span>
                          {run.p95MemMb != null && (
                            <span className="text-slate-400 ml-1">(P95: {formatMem(run.p95MemMb)})</span>
                          )}
                        </div>
                        <button 
                          onClick={(e) => handleDelete(e, run.id)}
                          className="mt-2 text-xs text-rose-500 hover:text-rose-700"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    // ========================
    // RunDetail Component
    // ========================
    function RunDetail({ runId, onBack }) {
      const [run, setRun] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        setLoading(true);
        api.getRun(runId)
          .then(setRun)
          .catch(console.error)
          .finally(() => setLoading(false));
      }, [runId]);

      // Process metrics for charts AND per-process summaries
      const { chartData, pids, processLabels, perPidSummaries } = useMemo(() => {
        if (!run?.report?.metrics) return { chartData: [], pids: [], processLabels: {}, perPidSummaries: [] };
        
        const metrics = run.report.metrics;
        const startTime = metrics[0]?.timestamp ? new Date(metrics[0].timestamp).getTime() : 0;
        const pidSet = new Set();
        const labels = {};
        const byPid = new Map();
        
        const snapshot = run.report?.meta?.process_snapshot || [];
        const snapByPid = new Map();
        for (const p of snapshot) {
          if (p.pid) {
            labels[p.pid] = p.alias || p.title || p.name || `PID ${p.pid}`;
            snapByPid.set(p.pid, p);
          }
        }
        
        const data = metrics.map(batch => {
          const ts = new Date(batch.timestamp).getTime();
          const elapsed = (ts - startTime) / 1000;
          const row = { timestamp: batch.timestamp, elapsed };
          
          for (const [pidStr, m] of Object.entries(batch.metrics || {})) {
            const pid = Number(pidStr);
            pidSet.add(pid);
            const cpu = m.cpu_chrome_usage ?? m.cpu_os_usage ?? m.cpu_usage;
            const mem = m.memory_private ?? m.memory_footprint ?? m.memory_rss;
            if (typeof cpu === 'number') row[`cpu_${pid}`] = cpu;
            if (typeof mem === 'number') row[`mem_${pid}`] = mem / (1024 * 1024);
            if (!labels[pid]) labels[pid] = `PID ${pid}`;
            
            if (!byPid.has(pid)) byPid.set(pid, { cpu: [], memMb: [] });
            const s = byPid.get(pid);
            if (typeof cpu === 'number' && Number.isFinite(cpu)) s.cpu.push(cpu);
            if (typeof mem === 'number' && Number.isFinite(mem)) s.memMb.push(mem / (1024 * 1024));
          }
          return row;
        });

        const summaries = Array.from(byPid.entries()).map(([pid, s]) => {
          const snap = snapByPid.get(pid);
          const avgCpu = avg(s.cpu);
          const maxCpu = s.cpu.length ? Math.max(...s.cpu) : null;
          const p50Cpu = percentile(s.cpu, 0.5);
          const p90Cpu = percentile(s.cpu, 0.9);
          const p95Cpu = percentile(s.cpu, 0.95);
          const p99Cpu = percentile(s.cpu, 0.99);
          const cpuStd = stddev(s.cpu, avgCpu);
          const cpuHigh30 = s.cpu.length ? s.cpu.filter(v => v > 30).length / s.cpu.length : null;
          const cpuHigh60 = s.cpu.length ? s.cpu.filter(v => v > 60).length / s.cpu.length : null;
          
          const avgMem = avg(s.memMb);
          const maxMem = s.memMb.length ? Math.max(...s.memMb) : null;
          const p50Mem = percentile(s.memMb, 0.5);
          const p90Mem = percentile(s.memMb, 0.9);
          const p95Mem = percentile(s.memMb, 0.95);
          const p99Mem = percentile(s.memMb, 0.99);
          const memStd = stddev(s.memMb, avgMem);
          const memHigh512 = s.memMb.length ? s.memMb.filter(v => v > 512).length / s.memMb.length : null;
          const memHigh1024 = s.memMb.length ? s.memMb.filter(v => v > 1024).length / s.memMb.length : null;
          const memGrowth = linregSlope(s.memMb);
          
          return {
            pid,
            title: labels[pid] || `PID ${pid}`,
            proc_type: snap?.proc_type || null,
            avg_cpu: avgCpu, max_cpu: maxCpu, p50_cpu: p50Cpu, p90_cpu: p90Cpu, p95_cpu: p95Cpu, p99_cpu: p99Cpu,
            cpu_stddev: cpuStd, cpu_high_30: cpuHigh30, cpu_high_60: cpuHigh60,
            avg_mem: avgMem, max_mem: maxMem, p50_mem: p50Mem, p90_mem: p90Mem, p95_mem: p95Mem, p99_mem: p99Mem,
            mem_stddev: memStd, mem_high_512: memHigh512, mem_high_1024: memHigh1024, mem_growth: memGrowth,
            samples: s.cpu.length,
          };
        }).sort((a, b) => (b.avg_cpu || 0) - (a.avg_cpu || 0));

        return {
          chartData: data,
          pids: Array.from(pidSet).sort((a, b) => a - b),
          processLabels: labels,
          perPidSummaries: summaries,
        };
      }, [run]);

      if (loading) {
        return <div className="p-6 text-center text-slate-500">Loading...</div>;
      }

      if (!run) {
        return <div className="p-6 text-center text-slate-500">Run not found</div>;
      }

      const meta = run.report?.meta || {};
      const analysis = run.report?.analysis || {};
      const insights = analysis.insights || [];
      const score = analysis.score;

      const cpuKeys = pids.map(pid => ({ key: `cpu_${pid}`, label: processLabels[pid] || `PID ${pid}` }));
      const memKeys = pids.map(pid => ({ key: `mem_${pid}`, label: processLabels[pid] || `PID ${pid}` }));
      
      const getScoreColor = (s) => {
        if (s == null) return 'text-slate-500';
        if (s >= 80) return 'text-emerald-600';
        if (s >= 60) return 'text-amber-600';
        return 'text-rose-600';
      };

      return (
        <div className="p-6">
          {/* Header */}
          <div className="flex items-center gap-4 mb-6">
            <button 
              onClick={onBack}
              className="p-2 hover:bg-slate-200 rounded-lg text-slate-600"
            >
              ← Back
            </button>
            <div>
              <h1 className="text-xl font-bold text-slate-800">{run.title}</h1>
              <div className="text-sm text-slate-500">
                {formatDate(run.reportDate)}
                {run.durationSeconds && <span className="ml-3">⏱ {formatDuration(run.durationSeconds)}</span>}
              </div>
            </div>
          </div>

          {/* Tags */}
          <div className="flex flex-wrap gap-2 mb-6">
            {run.release && (
              <span className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium">
                Release: {run.release}
              </span>
            )}
            {run.scenario && (
              <span className="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-sm">
                {run.scenario}
              </span>
            )}
            {run.platform && (
              <span className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-sm">
                {run.platform}
              </span>
            )}
            {run.mode && (
              <span className="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-sm">
                {run.mode}
              </span>
            )}
            {run.buildId && (
              <span className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-sm">
                Build: {run.buildId}
              </span>
            )}
          </div>

          {/* Metadata Section */}
          <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
            <div className="text-sm text-slate-500 uppercase font-bold mb-3">Metadata</div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">
              {/* Collection */}
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                <div className="text-xs text-slate-500 mb-2">Collection</div>
                <div className="space-y-1">
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">mode</span>
                    <span className="tabular-nums">{meta.collection?.mode || '—'}</span>
                  </div>
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">interval</span>
                    <span className="tabular-nums">{meta.collection?.interval_ms ? `${meta.collection.interval_ms}ms` : '—'}</span>
                  </div>
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">duration</span>
                    <span className="tabular-nums">{meta.collection?.duration_seconds ? `${meta.collection.duration_seconds}s` : '—'}</span>
                  </div>
                </div>
              </div>

              {/* Environment */}
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                <div className="text-xs text-slate-500 mb-2">Environment</div>
                <div className="space-y-1">
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">os</span>
                    <span className="tabular-nums">{meta.env?.os || '—'}</span>
                  </div>
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">device</span>
                    <span className="tabular-nums truncate max-w-[150px]">{meta.env?.device_name || '—'}</span>
                  </div>
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">cpu</span>
                    <span className="tabular-nums truncate max-w-[150px]" title={meta.env?.cpu_brand}>{meta.env?.cpu_brand || '—'}</span>
                  </div>
                  <div className="flex justify-between gap-3">
                    <span className="text-slate-400">RAM</span>
                    <span className="tabular-nums">
                      {meta.env?.total_memory_bytes ? `${Math.round(meta.env.total_memory_bytes / 1024 / 1024 / 1024)} GB` : 
                       meta.env?.total_mem_gb ? `${meta.env.total_mem_gb} GB` : '—'}
                    </span>
                  </div>
                </div>
              </div>

              {/* Targets */}
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                <div className="text-xs text-slate-500 mb-2">Targets</div>
                <div className="text-xs text-slate-600">
                  PIDs: {(meta.collection?.target_pids || []).join(', ') || '—'}
                </div>
                <div className="text-xs text-slate-500 mt-2">
                  snapshot: {(meta.process_snapshot?.length || 0)} processes
                </div>
              </div>
            </div>

            {/* Test Context */}
            {meta.test_context && (
              <div className="mt-4 bg-slate-50 border border-slate-200 rounded-lg p-3">
                <div className="text-xs text-slate-500 mb-2">Test Context</div>
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-3 text-sm">
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Scenario</div>
                    <div>{meta.test_context.scenario_name || '—'}</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-500 mb-1">Build ID</div>
                    <div className="tabular-nums">{meta.test_context.build_id || '—'}</div>
                  </div>
                  <div className="lg:col-span-2">
                    <div className="text-xs text-slate-500 mb-1">Tags</div>
                    <div>{(meta.test_context.tags || []).join(', ') || '—'}</div>
                  </div>
                  {meta.test_context.notes && (
                    <div className="lg:col-span-4">
                      <div className="text-xs text-slate-500 mb-1">Notes</div>
                      <div className="whitespace-pre-wrap">{meta.test_context.notes}</div>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Score + Per-Process Metrics */}
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            {/* Score Card */}
            <div className="bg-white border border-slate-200 p-5 rounded-xl flex flex-col items-center justify-center relative overflow-hidden">
              <div className="text-sm text-slate-500 uppercase font-bold mb-2">Performance Score</div>
              <div className={`text-5xl font-bold ${getScoreColor(score)}`}>
                {score != null ? score : '—'}
              </div>
            </div>

            {/* Per-Process Metrics */}
            <div className="lg:col-span-3 bg-white border border-slate-200 p-5 rounded-xl">
              <div className="text-sm text-slate-500 uppercase font-bold mb-3">Per-Process Metrics</div>
              <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                {perPidSummaries.map((p) => (
                  <div key={`proc_${p.pid}`} className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-sm font-medium truncate" title={p.title}>{p.title}</div>
                      <div className="text-xs text-slate-500 tabular-nums">{p.pid}</div>
                    </div>
                    <div className="text-xs text-slate-500 mb-3 truncate">{p.proc_type || '—'}</div>
                    
                    <div className="grid grid-cols-2 gap-4">
                      {/* CPU Column */}
                      <div>
                        <div className="text-xs text-slate-500 font-semibold mb-2">CPU</div>
                        <div className="text-xs space-y-1">
                          <div className="flex justify-between">
                            <span className="text-slate-400">avg</span>
                            <span className="tabular-nums">{p.avg_cpu != null ? `${p.avg_cpu.toFixed(1)}%` : '—'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">p95</span>
                            <span className="tabular-nums">{p.p95_cpu != null ? `${p.p95_cpu.toFixed(1)}%` : '—'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">max</span>
                            <span className="tabular-nums">{p.max_cpu != null ? `${p.max_cpu.toFixed(1)}%` : '—'}</span>
                          </div>
                        </div>
                      </div>
                      
                      {/* Memory Column */}
                      <div>
                        <div className="text-xs text-slate-500 font-semibold mb-2">Memory</div>
                        <div className="text-xs space-y-1">
                          <div className="flex justify-between">
                            <span className="text-slate-400">avg</span>
                            <span className="tabular-nums">{p.avg_mem != null ? `${p.avg_mem.toFixed(0)}MB` : '—'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">p95</span>
                            <span className="tabular-nums">{p.p95_mem != null ? `${p.p95_mem.toFixed(0)}MB` : '—'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">max</span>
                            <span className="tabular-nums">{p.max_mem != null ? `${p.max_mem.toFixed(0)}MB` : '—'}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Overall Stats */}
          {analysis.summary && (
            <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
              <div className="text-sm text-slate-500 uppercase font-bold mb-3">Overall Summary</div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <div className="text-xs text-slate-500">Avg CPU</div>
                  <div className="text-xl font-medium">{analysis.summary.avg_cpu?.toFixed(1) || '—'}%</div>
                </div>
                <div>
                  <div className="text-xs text-slate-500">Max CPU</div>
                  <div className="text-xl font-medium">{analysis.summary.max_cpu?.toFixed(1) || '—'}%</div>
                </div>
                <div>
                  <div className="text-xs text-slate-500">Avg Memory</div>
                  <div className="text-xl font-medium">{analysis.summary.avg_mem_mb?.toFixed(0) || '—'} MB</div>
                </div>
                <div>
                  <div className="text-xs text-slate-500">Max Memory</div>
                  <div className="text-xl font-medium">{analysis.summary.max_mem_mb?.toFixed(0) || '—'} MB</div>
                </div>
              </div>
            </div>
          )}

          {/* Insights */}
          {insights.length > 0 && (
            <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
              <h3 className="font-medium text-slate-800 mb-3">Insights</h3>
              <ul className="space-y-2">
                {insights.map((insight, i) => (
                  <li key={i} className="flex items-start gap-2 text-sm text-slate-600">
                    <span className="text-amber-500">⚡</span>
                    {insight}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Charts */}
          {chartData.length > 0 && cpuKeys.length > 0 && (
            <LineChartComponent
              data={chartData}
              dataKeys={cpuKeys}
              title="CPU Usage (%)"
              yLabel="CPU %"
              formatValue={(v) => v != null ? `${v.toFixed(1)}%` : 'N/A'}
            />
          )}

          {chartData.length > 0 && memKeys.length > 0 && (
            <LineChartComponent
              data={chartData}
              dataKeys={memKeys}
              title="Memory Usage (MB)"
              yLabel="Memory (MB)"
              formatValue={(v) => v != null ? `${v.toFixed(1)} MB` : 'N/A'}
            />
          )}

          {/* Process Snapshot Table */}
          {(meta.process_snapshot || []).length > 0 && (
            <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
              <h3 className="font-medium text-slate-800 mb-4">Process Snapshot</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b border-slate-200">
                      <th className="text-left py-2 px-2 text-slate-500 font-medium">PID</th>
                      <th className="text-left py-2 px-2 text-slate-500 font-medium">Name</th>
                      <th className="text-left py-2 px-2 text-slate-500 font-medium">Title</th>
                      <th className="text-left py-2 px-2 text-slate-500 font-medium">Type</th>
                      <th className="text-left py-2 px-2 text-slate-500 font-medium">Alias</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(meta.process_snapshot || []).map((p, i) => (
                      <tr key={i} className="border-b border-slate-100 hover:bg-slate-50">
                        <td className="py-2 px-2 tabular-nums">{p.pid}</td>
                        <td className="py-2 px-2">{p.name || '—'}</td>
                        <td className="py-2 px-2 max-w-[200px] truncate" title={p.title}>{p.title || '—'}</td>
                        <td className="py-2 px-2">{p.proc_type || '—'}</td>
                        <td className="py-2 px-2">{p.alias || '—'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ========================
    // RunCompare Component
    // ========================
    function RunCompare({ runIds, initialContext, onBack, onViewDetail }) {
      const [runs, setRuns] = useState([]);
      const [loading, setLoading] = useState(true);
      const [tab, setTab] = useState('cpu'); // 'cpu' | 'mem'
      const [baselineId, setBaselineId] = useState(null);
      const [cpuSelById, setCpuSelById] = useState({});
      const [memSelById, setMemSelById] = useState({});
      const [isExporting, setIsExporting] = useState(false);
      const [isExportingBundle, setIsExportingBundle] = useState(false);

      useEffect(() => {
        loadRuns();
      }, [runIds]);

      const loadRuns = async () => {
        try {
          setLoading(true);
          const results = await Promise.all(
            runIds.map(id => api.getRun(id))
          );
          setRuns(results.filter(Boolean));
          
          // Use baseline from initialContext if available, otherwise first report
          if (initialContext?.baselineId) {
            setBaselineId(initialContext.baselineId);
          } else if (results.length > 0) {
            setBaselineId(results[0]?.id);
          }

          // Initialize selections - use initialContext if available, otherwise all PIDs
          const nextCpu = {};
          const nextMem = {};
          results.forEach(r => {
            if (!r?.report) return;
            const pids = extractPids(r);
            
            // Check if we have initial selections from bundle
            if (initialContext?.cpuSelections?.[r.id]) {
              nextCpu[r.id] = initialContext.cpuSelections[r.id];
            } else {
              nextCpu[r.id] = pids;
            }
            
            if (initialContext?.memSelections?.[r.id]) {
              nextMem[r.id] = initialContext.memSelections[r.id];
            } else {
              nextMem[r.id] = pids;
            }
          });
          setCpuSelById(nextCpu);
          setMemSelById(nextMem);
        } catch (e) {
          console.error('Failed to load runs:', e);
        } finally {
          setLoading(false);
        }
      };

      const extractPids = (run) => {
        if (!run?.report?.metrics) return [];
        const pids = new Set();
        run.report.metrics.forEach(b => {
          Object.keys(b.metrics || {}).forEach(pidStr => {
            const pid = Number(pidStr);
            if (Number.isFinite(pid)) pids.add(pid);
          });
        });
        return Array.from(pids);
      };

      const getProcLabel = (run, pid) => {
        const snap = run?.report?.meta?.process_snapshot || [];
        const p = snap.find(s => s.pid === pid);
        return p?.alias || p?.title || p?.name || `PID ${pid}`;
      };

      const getColorForRun = (runId) => {
        const idx = runs.findIndex(r => r.id === runId);
        if (runId === baselineId) return COLORS.BASELINE;
        return COLORS.PALETTE[idx % COLORS.PALETTE.length];
      };

      // Build aligned chart data
      const alignedData = useMemo(() => {
        if (runs.length < 2) return [];
        const baseline = runs.find(r => r.id === baselineId) || runs[0];
        const intervalMs = baseline?.report?.meta?.collection?.interval_ms || 1000;
        const maxLen = Math.max(...runs.map(r => (r?.report?.metrics || []).length));
        
        const data = [];
        for (let i = 0; i < maxLen; i++) {
          const row = { time_s: (i * intervalMs) / 1000 };
          
          runs.forEach(r => {
            if (!r?.report?.metrics?.[i]) return;
            const batch = r.report.metrics[i];
            const selectedPids = new Set(tab === 'cpu' ? (cpuSelById[r.id] || []) : (memSelById[r.id] || []));
            
            if (!selectedPids.size) {
              row[`${tab}_${r.id}`] = null;
              return;
            }
            
            let total = 0;
            Object.entries(batch.metrics || {}).forEach(([pidStr, m]) => {
              const pid = Number(pidStr);
              if (!selectedPids.has(pid)) return;
              
              if (tab === 'cpu') {
                const cpu = m.cpu_chrome_usage ?? m.cpu_os_usage ?? m.cpu_usage;
                if (typeof cpu === 'number' && Number.isFinite(cpu)) total += cpu;
              } else {
                const mem = m.memory_private ?? m.memory_footprint ?? m.memory_rss;
                if (typeof mem === 'number' && Number.isFinite(mem)) total += mem / (1024 * 1024);
              }
            });
            
            row[`${tab}_${r.id}`] = total;
          });
          
          data.push(row);
        }
        return data;
      }, [runs, tab, cpuSelById, memSelById, baselineId]);

      // Stats per run
      const statsById = useMemo(() => {
        const out = {};
        runs.forEach(r => {
          if (!r?.id) return;
          const values = alignedData.map(d => d[`${tab}_${r.id}`]).filter(v => v != null && Number.isFinite(v));
          out[r.id] = {
            avg: avg(values),
            p95: percentile(values, 0.95),
            max: values.length ? Math.max(...values) : null,
            samples: values.length,
          };
        });
        return out;
      }, [runs, alignedData, tab]);

      const togglePid = (runId, pid) => {
        const setter = tab === 'cpu' ? setCpuSelById : setMemSelById;
        setter(prev => {
          const arr = prev[runId] || [];
          const set = new Set(arr);
          if (set.has(pid)) set.delete(pid);
          else set.add(pid);
          return { ...prev, [runId]: Array.from(set) };
        });
      };

      if (loading) {
        return <div className="p-6 text-center text-slate-500">Loading comparison...</div>;
      }

      if (runs.length < 2) {
        return (
          <div className="p-6 text-center text-slate-500">
            Need at least 2 reports to compare.
            <button onClick={onBack} className="block mt-4 text-indigo-600 hover:underline">← Back to list</button>
          </div>
        );
      }

      const chartDataKeys = runs.map(r => ({
        key: `${tab}_${r.id}`,
        label: r.title,
        color: getColorForRun(r.id),
      }));

      // Delta badge helper
      const deltaBadge = (delta, isWorse) => {
        if (delta == null || !Number.isFinite(delta)) return null;
        const worse = isWorse ? delta > 0 : delta < 0;
        const cls = worse
          ? 'text-rose-600 bg-rose-50 border-rose-200'
          : 'text-emerald-600 bg-emerald-50 border-emerald-200';
        const arrow = worse ? '↑' : '↓';
        return (
          <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded border text-xs font-medium ${cls}`}>
            {arrow} {delta > 0 ? '+' : ''}{delta.toFixed(1)}{tab === 'cpu' ? '%' : ' MB'}
          </span>
        );
      };

      // Export bundle handler
      const handleExportBundle = async () => {
        try {
          setIsExportingBundle(true);
          const bundle = {
            schema_version: 1,
            bundle_type: "comparison",
            exported_at: new Date().toISOString(),
            comparison_context: {
              baseline_original_id: baselineId,
              cpu_selections_by_id: cpuSelById,
              mem_selections_by_id: memSelById,
            },
            reports: runs.map(r => ({
              id: r.originalId || r.id,
              created_at: r.reportDate,
              title: r.title,
              metrics: r.report?.metrics || [],
              analysis: r.report?.analysis || null,
              meta: r.report?.meta || {},
            })),
          };
          const json = JSON.stringify(bundle, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `comparison_bundle_${runs.length}_reports_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error('Bundle export failed:', e);
          alert('Failed to export bundle');
        } finally {
          setIsExportingBundle(false);
        }
      };

      return (
        <div className="p-6">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-4">
              <button 
                onClick={onBack}
                className="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
              </button>
              <div>
                <h1 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                  <svg className="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                  Comparison
                </h1>
                <div className="text-sm text-slate-500">{runs.length} reports selected</div>
              </div>
            </div>

            {/* Export Buttons */}
            <div className="flex items-center gap-2">
              <button
                onClick={handleExportBundle}
                disabled={isExportingBundle}
                className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-60 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                {isExportingBundle ? 'Exporting...' : 'Export Bundle'}
              </button>
            </div>
          </div>

          {/* Baseline Selector Card */}
          <div className="bg-white border border-slate-200 rounded-xl p-4 mb-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div>
                <div className="text-sm font-medium text-slate-700">Baseline Selection</div>
                <div className="text-xs text-slate-500">Choose a baseline to enable delta comparison, or select "None" for overlay mode.</div>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-xs text-slate-500">Baseline</span>
                <select
                  value={baselineId || ''}
                  onChange={e => setBaselineId(e.target.value || null)}
                  className="px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm min-w-[200px]"
                >
                  <option value="">None (overlay)</option>
                  {runs.map(r => (
                    <option key={r.id} value={r.id}>#{r.originalId || r.id} — {r.title}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          {/* Metric Tabs */}
          <div className="flex gap-2 mb-6">
            <button
              onClick={() => setTab('cpu')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                tab === 'cpu' 
                  ? 'bg-indigo-600 text-white' 
                  : 'bg-white border border-slate-200 text-slate-700 hover:bg-slate-50'
              }`}
            >
              CPU
            </button>
            <button
              onClick={() => setTab('mem')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                tab === 'mem' 
                  ? 'bg-indigo-600 text-white' 
                  : 'bg-white border border-slate-200 text-slate-700 hover:bg-slate-50'
              }`}
            >
              Memory
            </button>
          </div>

          {/* Summary Stats Table */}
          <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6 overflow-x-auto">
            <div className="text-sm text-slate-500 uppercase font-bold mb-4">
              {tab === 'cpu' ? 'CPU' : 'Memory'} Comparison Summary
            </div>
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-slate-200">
                  <th className="text-left py-2 pr-4 text-slate-500 font-medium">Report</th>
                  <th className="text-right py-2 px-3 text-slate-500 font-medium">Avg</th>
                  <th className="text-right py-2 px-3 text-slate-500 font-medium">P95</th>
                  <th className="text-right py-2 px-3 text-slate-500 font-medium">Max</th>
                  {baselineId && <th className="text-right py-2 pl-3 text-slate-500 font-medium">Δ vs Baseline</th>}
                </tr>
              </thead>
              <tbody>
                {runs.map(r => {
                  const stats = statsById[r.id] || {};
                  const isBaseline = r.id === baselineId;
                  const color = getColorForRun(r.id);
                  const baseStats = baselineId ? (statsById[baselineId] || {}) : {};
                  const avgDelta = baselineId && !isBaseline && stats.avg != null && baseStats.avg != null
                    ? stats.avg - baseStats.avg
                    : null;
                  
                  return (
                    <tr key={r.id} className="border-b border-slate-100 hover:bg-slate-50">
                      <td className="py-3 pr-4">
                        <div className="flex items-center gap-2 min-w-0">
                          <div className="w-3 h-3 rounded-full shrink-0" style={{ backgroundColor: color }} />
                          <span className="truncate font-medium">{r.title}</span>
                          {isBaseline && (
                            <span className="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded shrink-0">Baseline</span>
                          )}
                        </div>
                      </td>
                      <td className="py-3 px-3 text-right tabular-nums font-medium">
                        {tab === 'cpu' ? formatCpu(stats.avg) : formatMem(stats.avg)}
                      </td>
                      <td className="py-3 px-3 text-right tabular-nums font-medium">
                        {tab === 'cpu' ? formatCpu(stats.p95) : formatMem(stats.p95)}
                      </td>
                      <td className="py-3 px-3 text-right tabular-nums font-medium">
                        {tab === 'cpu' ? formatCpu(stats.max) : formatMem(stats.max)}
                      </td>
                      {baselineId && (
                        <td className="py-3 pl-3 text-right">
                          {isBaseline ? (
                            <span className="text-xs text-slate-400">—</span>
                          ) : avgDelta != null ? (
                            deltaBadge(avgDelta, true)
                          ) : (
                            <span className="text-xs text-slate-400">—</span>
                          )}
                        </td>
                      )}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Per-Report Process Selectors */}
          <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
            <div className="text-sm text-slate-500 uppercase font-bold mb-3">
              Select Processes per Report
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {runs.map(r => {
                const pids = extractPids(r);
                const selectedPids = new Set(tab === 'cpu' ? (cpuSelById[r.id] || []) : (memSelById[r.id] || []));
                const color = getColorForRun(r.id);
                
                return (
                  <div key={r.id} className="border border-slate-200 rounded-xl p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <div className="w-2 h-2 rounded-full" style={{ backgroundColor: color }} />
                        <span className="text-sm font-medium truncate">{r.title}</span>
                      </div>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            const setter = tab === 'cpu' ? setCpuSelById : setMemSelById;
                            setter(prev => ({ ...prev, [r.id]: pids }));
                          }}
                          className="text-xs px-2 py-1 text-slate-600 hover:bg-slate-100 rounded"
                        >
                          All
                        </button>
                        <button
                          onClick={() => {
                            const setter = tab === 'cpu' ? setCpuSelById : setMemSelById;
                            setter(prev => ({ ...prev, [r.id]: [] }));
                          }}
                          className="text-xs px-2 py-1 text-slate-600 hover:bg-slate-100 rounded"
                        >
                          None
                        </button>
                      </div>
                    </div>
                    <div className="max-h-[200px] overflow-y-auto custom-scrollbar space-y-1">
                      {pids.map(pid => {
                        const checked = selectedPids.has(pid);
                        return (
                          <button
                            key={pid}
                            onClick={() => togglePid(r.id, pid)}
                            className={`w-full flex items-center gap-2 px-2 py-1.5 rounded text-sm text-left transition-colors ${
                              checked ? 'bg-indigo-50 text-indigo-700' : 'hover:bg-slate-50'
                            }`}
                          >
                            <span className={`w-4 h-4 rounded border flex items-center justify-center ${
                              checked ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'
                            }`}>
                              {checked && (
                                <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                </svg>
                              )}
                            </span>
                            <span className="truncate">{getProcLabel(r, pid)}</span>
                            <span className="text-xs text-slate-400 ml-auto">{pid}</span>
                          </button>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Comparison Chart */}
          {alignedData.length > 0 && (
            <LineChartComponent
              data={alignedData}
              dataKeys={chartDataKeys}
              title={tab === 'cpu' ? 'CPU Usage Comparison' : 'Memory Usage Comparison'}
              yLabel={tab === 'cpu' ? 'CPU (%)' : 'Memory (MB)'}
              formatValue={(v) => v != null ? (tab === 'cpu' ? `${v.toFixed(1)}%` : `${v.toFixed(1)} MB`) : 'N/A'}
            />
          )}

          {/* Per-Report Details */}
          <div className="bg-white border border-slate-200 rounded-xl p-5 mb-6">
            <div className="text-sm text-slate-500 uppercase font-bold mb-4">Report Details</div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {runs.map(r => {
                const color = getColorForRun(r.id);
                const meta = r.report?.meta || {};
                const testCtx = meta.test_context || {};
                const isBaseline = r.id === baselineId;
                const stats = statsById[r.id] || {};
                const baseStats = baselineId ? (statsById[baselineId] || {}) : {};
                
                return (
                  <div 
                    key={r.id} 
                    className={`border rounded-xl p-4 ${isBaseline ? 'border-indigo-300 bg-indigo-50/30' : 'border-slate-200'}`}
                  >
                    <div className="flex items-center gap-3 mb-4">
                      <div className="w-4 h-4 rounded-full shrink-0" style={{ backgroundColor: color }} />
                      <div className="min-w-0 flex-1">
                        <div className="font-semibold truncate">{r.title}</div>
                        <div className="text-xs text-slate-500">{formatDate(r.reportDate)}</div>
                      </div>
                      {isBaseline && (
                        <span className="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded-lg font-medium shrink-0">Baseline</span>
                      )}
                      <button
                        onClick={() => onViewDetail && onViewDetail(r.id)}
                        className="text-xs px-2 py-1 text-indigo-600 hover:bg-indigo-50 rounded transition-colors shrink-0"
                        title="View full report details"
                      >
                        Details →
                      </button>
                    </div>
                    
                    {/* Quick Stats */}
                    <div className="grid grid-cols-3 gap-3 mb-4">
                      <div className="bg-slate-50 rounded-lg p-2 text-center">
                        <div className="text-xs text-slate-500">Avg {tab === 'cpu' ? 'CPU' : 'Mem'}</div>
                        <div className="font-semibold tabular-nums text-sm">
                          {tab === 'cpu' ? formatCpu(stats.avg) : formatMem(stats.avg)}
                        </div>
                        {!isBaseline && baselineId && stats.avg != null && baseStats.avg != null && (
                          <div className="mt-1">
                            {deltaBadge(stats.avg - baseStats.avg, true)}
                          </div>
                        )}
                      </div>
                      <div className="bg-slate-50 rounded-lg p-2 text-center">
                        <div className="text-xs text-slate-500">P95</div>
                        <div className="font-semibold tabular-nums text-sm">
                          {tab === 'cpu' ? formatCpu(stats.p95) : formatMem(stats.p95)}
                        </div>
                      </div>
                      <div className="bg-slate-50 rounded-lg p-2 text-center">
                        <div className="text-xs text-slate-500">Max</div>
                        <div className="font-semibold tabular-nums text-sm">
                          {tab === 'cpu' ? formatCpu(stats.max) : formatMem(stats.max)}
                        </div>
                      </div>
                    </div>
                    
                    {/* Metadata */}
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                      <div>
                        <span className="text-slate-500">Platform:</span>{' '}
                        <span className="font-medium">{r.platform || '—'}</span>
                      </div>
                      <div>
                        <span className="text-slate-500">Mode:</span>{' '}
                        <span className="font-medium">{r.mode || '—'}</span>
                      </div>
                      <div>
                        <span className="text-slate-500">Duration:</span>{' '}
                        <span className="font-medium">{formatDuration(r.durationSeconds)}</span>
                      </div>
                      <div>
                        <span className="text-slate-500">Samples:</span>{' '}
                        <span className="font-medium">{stats.samples || 0}</span>
                      </div>
                      {testCtx.scenario_name && (
                        <div className="col-span-2">
                          <span className="text-slate-500">Scenario:</span>{' '}
                          <span className="font-medium">{testCtx.scenario_name}</span>
                        </div>
                      )}
                      {testCtx.build_id && (
                        <div className="col-span-2">
                          <span className="text-slate-500">Build ID:</span>{' '}
                          <span className="font-mono text-xs bg-slate-100 px-1.5 py-0.5 rounded">{testCtx.build_id}</span>
                        </div>
                      )}
                    </div>
                    
                    {/* Tags */}
                    {r.tags && r.tags.length > 0 && (
                      <div className="mt-3 pt-3 border-t border-slate-100">
                        <div className="flex flex-wrap gap-1">
                          {(Array.isArray(r.tags) ? r.tags : []).map((tag, i) => (
                            <span key={i} className="text-xs px-2 py-0.5 bg-slate-100 text-slate-600 rounded">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // ========================
    // App Component
    // ========================
    function App() {
      const [view, setView] = useState('list'); // 'list' | 'detail' | 'compare'
      const [selectedRunId, setSelectedRunId] = useState(null);
      const [compareIds, setCompareIds] = useState([]);
      const [compareContext, setCompareContext] = useState(null); // For bundle imports

      const handleSelect = (id) => {
        setSelectedRunId(id);
        setView('detail');
      };

      const handleBack = () => {
        setView('list');
        setSelectedRunId(null);
        setCompareIds([]);
        setCompareContext(null);
      };

      const handleCompare = (ids, context = null) => {
        setCompareIds(ids);
        setCompareContext(context);
        setView('compare');
      };

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="bg-white border-b border-slate-200 px-6 py-4">
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                <span className="text-white font-bold text-sm">P</span>
              </div>
              <h1 className="text-lg font-semibold text-slate-800">PerfSight Server</h1>
            </div>
          </header>

          {/* Content */}
          <main className="max-w-6xl mx-auto">
            {view === 'list' && (
              <RunsList onSelect={handleSelect} onCompare={handleCompare} />
            )}
            {view === 'detail' && (
              <RunDetail runId={selectedRunId} onBack={handleBack} />
            )}
            {view === 'compare' && (
              <RunCompare 
                runIds={compareIds} 
                initialContext={compareContext} 
                onBack={handleBack}
                onViewDetail={(id) => {
                  setSelectedRunId(id);
                  setView('detail');
                }}
              />
            )}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
